#+title: Gentoo Install(LUKS,BTRFS)
#+author: keke
#+email: liushike1997@gmail.com
#+date: <2020-04-30 Thu>
#+export_file_name: ~/keke-cute.github.io/blog/gentooinstall2.html
#+options: creator:t author:t
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="blog/css/m-dark.css" />
#+HTML_HEAD_EXTRA: <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,400i,600%7CSource+Sans+Pro:400,400i,600&amp;subset=latin-ext" />
#+HTML_HEAD_EXTRA: <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
* Livecd ğŸ’¿
  [[http://www.system-rescue-cd.org/]]
* åˆ†åŒº ğŸ’¾
  #+BEGIN_SRC bash
    â¯ lsblk
    NAME     MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
    sda        8:0    0  477G  0 disk
    â””â”€sda1     8:1    0  477G  0 part
      â””â”€root 254:0    0  477G  0 crypt /
    â¯ fdisk /dev/sda1
    o å»ºç«‹æ–°çš„dosåˆ†åŒºè¡¨
    n å»ºç«‹æ–°çš„åˆ†åŒº
    w å†™å…¥åˆ†åŒºè¡¨
  #+END_SRC
* ä½¿ç”¨luksåŠ å¯†è¯¥åˆ†åŒº ğŸ”
  #+begin_src bash
    â¯ cryptsetup -s 512 --type luks1 luksFormat /dev/sda1
    This will overwrite data on /dev/sda1 irrevocably.

    Are you sure? (Type uppercase yes): YES
    Enter LUKS passphrase: ...
    Verify passphrase: ...
  #+end_src
  å¤‡ä»½luksæ ‡å¤´æ–‡ä»¶ï¼Œå¿˜è®°å¯†ç çš„æ—¶å€™å¯ä»¥æ¢å¤ğŸ“ƒ
  #+begin_src bash
    â¯ cryptsetup luksHeaderBackup /dev/sda1 --header-backup-file /path/to/you/want/luks-header.img
  #+end_src
* æ‰“å¼€åŠ å¯†è¿‡çš„åˆ†åŒºå¹¶æ ¼å¼åŒ–ä¸ºbtrfsæ–‡ä»¶ç³»ç»Ÿ ğŸ“ƒ
  #+begin_src bash
    â¯ cryptsetup luksOpen /dev/sda1 root
    Enter passphrase for /dev/sda1: ...
  #+end_src
  æ ¼å¼åŒ–å¹¶æŒ‚è½½
  #+begin_src bash
    â¯ mkfs.btrfs /dev/mapper/root
      mkdir /mnt/gentoo
      mount /dev/mapper/root /mnt/gentoo
  #+end_src
* åŸºæœ¬ç³»ç»Ÿå®‰è£… ğŸ”Œ
  ä¸‹è½½å¹¶è§£å‹åˆ°æ ¹ç›®å½•stage3æ–‡ä»¶

  [[https://mirrors.tuna.tsinghua.edu.cn/gentoo/]]

  è¿›å…¥é•œåƒç«™çš„/gentoo/releases/amd64/autobuilds/ç›®å½•ï¼Œé€‰æ‹©æƒ³è¦çš„stage3ç±»å‹æ¯”å¦‚nomultilib(stage3-amd64-nomultilib-20200212T214502Z.tar.xz)
  #+begin_src bash
    â¯ cd /mnt/gentoo
      wget https://mirrors.tuna.tsinghua.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-nomultilib/stage3-amd64-nomultilib-20200212T214502Z.tar.xz
      tar vxpf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
  #+end_src
  é…ç½®make.conf&gentoo.conf,æ‰‹åŠ¨clone gentoo mirror repos
  #+begin_src bash
  â¯ nano /mnt/gentoo/etc/portage/make.conf
  #+end_src
  my thinkpad x220 laptop:
  #+begin_src conf
    # GCC
    CFLAGS="-march=sandybridge -O2 -pipe"
    CXXFLAGS="${CFLAGS}"
    CHOST="x86_64-pc-linux-gnu"
    CPU_FLAGS_X86="aes avx mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3"
    MAKEOPTS="-j5"

    # USE
    USE="-bindist pulseaudio gtk"

    # Portage
    GENTOO_MIRRORS="https://mirrors.tuna.tsinghua.edu.cn/gentoo/"
    EMERGE_DEFAULT_OPTS="--ask --verbose=y --keep-going --with-bdeps=y --load-average"
    # FEATURES="${FEATURES} -userpriv -usersandbox -sandbox"
    ACCEPT_KEYWORDS="~amd64"
    ACCEPT_LICENSE="*"

    # Language
    L10N="en-US zh-CN en zh"
    LINGUAS="en_US zh_CN en zh"

    # Else
    VIDEO_CARDS="intel i965"
    GRUB_PLATFORMS="pc coreboot"
  #+end_src
  my ryzen pc:
  #+begin_src conf
    # GCC
    CFLAGS="-march=znver1 -O2 -pipe"
    CXXFLAGS="${CFLAGS}"
    CHOST="x86_64-pc-linux-gnu"
    CPU_FLAGS_X86="aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 sse4a ssse3"
    MAKEOPTS="-j13"

    # USE
    USE="-bindist pulseaudio gtk"

    # Portage
    GENTOO_MIRRORS="https://mirrors.tuna.tsinghua.edu.cn/gentoo/"
    EMERGE_DEFAULT_OPTS="--ask --verbose=y --keep-going --with-bdeps=y --load-average"
    # FEATURES="${FEATURES} -userpriv -usersandbox -sandbox"
    ACCEPT_KEYWORDS="~amd64"
    ACCEPT_LICENSE="*"

    # Language
    L10N="en-US zh-CN en zh"
    LINGUAS="en_US zh_CN en zh"

    # Else
    VIDEO_CARDS="amdgpu radeonsi"
    GRUB_PLATFORMS="pc"
  #+end_src
  é…ç½®repos:
  #+begin_src bash
    â¯ mkdir /mnt/gentoo/etc/portage/repos.conf
      nano /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
  #+end_src
  #+begin_src conf
    [DEFAULT]
    main-repo = gentoo

    [gentoo]
    location = /var/db/repos/gentoo
    sync-type = git
    sync-uri = https://github.com/gentoo-mirror/gentoo
    auto-sync = yes
  #+end_src
  æ‰‹åŠ¨clone gentoo mirror repos:
  #+begin_src bash
    â¯ git clone --depths=1 https://github.com/gentoo-mirror/gentoo /mnt/gentoo/var/db/repos/gentoo
  #+end_src

  å¤åˆ¶ç›¸å…³æ–‡ä»¶å¹¶chroot:
  #+begin_src bash
    # DNS
    â¯ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
    # MOUNT
    â¯
      mount -t proc none proc 
      mount --rbind /sys sys 
      mount --rbind /dev dev
    # CHROOT
    â¯
      chroot /mnt/gentoo /bin/bash
      source /etc/profile
      export PS1="(chroot) ${PS1}"  
  #+end_src
  å®‰è£…åŸºç¡€ç¨‹åº:
  #+begin_src bash
    â¯ emerge -av dev-vcs/git eix
  #+end_src
  é€‰æ‹©profile:
  #+begin_src bash
    â¯ eselect profile list
      eselect profile set x
  #+end_src
  æ›´æ–°ç³»ç»Ÿ:
  #+begin_src bash
    â¯ eix-sync(å¯é€‰)
    â¯ emerge -avuDN @world
  #+end_src
* é…ç½®æ—¶åŒºå’Œåœ°åŒº ğŸŒ
  #+begin_src bash
    â¯
      echo "Asia/Shanghai" > /etc/timezone
      emerge --config sys-libs/timezone-data

      echo "en_US.UTF-8 UTF-8
      zh_CN.UTF-8 UTF-8" >> /etc/locale.gen

      locale-gen

      eselect locale list

      eselect locale set X

      #ä¿®æ”¹ä¸»æœºå
      echo hostname=\"Thinkpad\" > /etc/conf.d/hostname
  #+end_src
* FSTAB ğŸª€
  #+begin_src bash
    â¯ blkid /dev/mapper/root
    /dev/mapper/root: UUID="xx" UUID_SUB="xx" BLOCK_SIZE="4096" TYPE="btrfs"
    â¯ nano /etc/fstab
    UUID="/dev/mapper/rootçš„UUID"             /               btrfs           defaults0 1
  #+end_src
* å†…æ ¸ç¼–è¯‘å’Œå¼•å¯¼
  ä¸‹è½½å†…æ ¸å’Œgenkernel
  #+BEGIN_SRC bash
    â¯ emerge -av gentoo-sources genkernel 
    â¯ genkernel --luks --lvm --btrfs --bootloader=grub2 all
    â¯ genkernel --luks --lvm --btrfs initramfs
  #+END_SRC
  USE:
  #+BEGIN_SRC bash
    â¯
      echo "sys-fs/cryptsetup static" > /etc/portage/package.use/cryptsetup
      echo "sys-boot/grub device-mapper" > /etc/portage/package.use/grub
  #+END_SRC
  å®‰è£…grubå’Œcryptsetup
  #+BEGIN_SRC bash
    â¯ emerge -av grub cryptsetup
  #+END_SRC
  GRUBé…ç½®:
  #+BEGIN_SRC bash
    â¯ nano /etc/default/grub
  #+END_SRC
  #+BEGIN_SRC conf
    GRUB_DISTRIBUTOR="Gentoo"
    GRUB_ENABLE_CRYPTODISK=y
    GRUB_CMDLINE_LINUX="dobtrfs crypt_root=UUID=?????? root=/dev/mapper/root"
    #æ­¤å¤„çš„UUIDä¸º/dev/sda1è®¾å¤‡çš„è€Œä¸æ˜¯mapperçš„
  #+END_SRC
  dmcrtpté…ç½®:
  #+BEGIN_SRC bash
    â¯ nano /etc/conf.d/dmcrypt
  #+END_SRC
  #+BEGIN_SRC conf
    target=root
    source='/dev/sda1'
  #+END_SRC
  dmcryptæ·»åŠ åˆ°bootçº§åˆ«:
  #+BEGIN_SRC bash
    â¯ rc-update add dmcrypt boot
  #+END_SRC
  å®‰è£…å¼•å¯¼:
  #+BEGIN_SRC bash
    â¯ grub-install --target=i386-pc /dev/sda
    â¯ grub-mkconfig -o /boot/grub/grub.cfg
    # è®°å¾—æ£€æŸ¥ä¸€ä¸‹grub.cfgæœ‰æ— luks
  #+END_SRC
* æœ€åé…ç½®ï¼Œå‡†å¤‡ç»“æŸ
  å®‰è£…sudoï¼Œdhcpcd
  #+BEGIN_SRC bash
    â¯ emerge -av sudo dhcpcd
  #+END_SRC
  ä¿®æ”¹root å¯†ç ï¼Œåˆ›å»ºç”¨æˆ·
  #+BEGIN_SRC bash
    â¯ 
      passwd
      useradd -m -G users,wheel,portage,usb,video xx
      passwd xx
  #+END_SRC
  ç»“æŸ
  #+BEGIN_SRC bash
    â¯ 
      sed -i 's/\# \%wheel ALL=(ALL) ALL/\%wheel ALL=(ALL) ALL/g' /etc/sudoers
      exit
      umount -lR {dev,proc,sys} 
      cryptsetup luksClose /dev/sda1
      reboot
  #+END_SRC
  Happy Enjoy!
