#+title: Gentoo Install(LUKS,BTRFS)
#+author: keke
#+email: liushike1997@gmail.com
#+date: <2020-04-30 Thu>
#+export_file_name: ~/keke-cute.github.io/blog/gentooinstall2.html
#+options: creator:t author:t
* Livecd 💿
  [[http://www.system-rescue-cd.org/]]
* 分区 💾
  #+BEGIN_SRC bash
    ❯ lsblk
    NAME     MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
    sda        8:0    0  477G  0 disk
    └─sda1     8:1    0  477G  0 part
      └─root 254:0    0  477G  0 crypt /
    ❯ fdisk /dev/sda1
    o 建立新的dos分区表
    n 建立新的分区
    w 写入分区表
  #+END_SRC
* 使用luks加密该分区 🔐
  #+begin_src bash
    ❯ cryptsetup -s 512 luksFormat /dev/sda1
    This will overwrite data on /dev/sda1 irrevocably.

    Are you sure? (Type uppercase yes): YES
    Enter LUKS passphrase: ...
    Verify passphrase: ...
  #+end_src
  备份luks标头文件，忘记密码的时候可以恢复📃
  #+begin_src bash
    ❯ cryptsetup luksHeaderBackup /dev/sda1 --header-backup-file /path/to/you/want/luks-header.img
  #+end_src
* 打开加密过的分区并格式化为btrfs文件系统 📃
  #+begin_src bash
    ❯ cryptsetup luksOpen /dev/sda1 root
    Enter passphrase for /dev/sda1: ...
  #+end_src
  格式化并挂载
  #+begin_src bash
    ❯ mkfs.btrfs /dev/mapper/root
      mkdir /mnt/gentoo
      mount /dev/mapper/root /mnt/gentoo
  #+end_src
* 基本系统安装 🔌
  下载并解压到根目录stage3文件

  [[https://mirrors.tuna.tsinghua.edu.cn/gentoo/]]

  进入镜像站的/gentoo/releases/amd64/autobuilds/目录，选择想要的stage3类型比如nomultilib(stage3-amd64-nomultilib-20200212T214502Z.tar.xz)
  #+begin_src bash
    ❯ cd /mnt/gentoo
      wget https://mirrors.tuna.tsinghua.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-nomultilib/stage3-amd64-nomultilib-20200212T214502Z.tar.xz
      tar vxpf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
  #+end_src
  配置make.conf&gentoo.conf,手动clone gentoo mirror repos
  #+begin_src bash
  ❯ nano /mnt/gentoo/etc/portage/make.conf
  #+end_src
  my thinkpad x220 laptop:
  #+begin_src conf
    # GCC
    CFLAGS="-march=sandybridge -O2 -pipe"
    CXXFLAGS="${CFLAGS}"
    CHOST="x86_64-pc-linux-gnu"
    CPU_FLAGS_X86="aes avx mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3"
    MAKEOPTS="-j5"

    # USE
    USE="-bindist pulseaudio gtk"

    # Portage
    GENTOO_MIRRORS="https://mirrors.tuna.tsinghua.edu.cn/gentoo/"
    EMERGE_DEFAULT_OPTS="--ask --verbose=y --keep-going --with-bdeps=y --load-average"
    # FEATURES="${FEATURES} -userpriv -usersandbox -sandbox"
    ACCEPT_KEYWORDS="~amd64"
    ACCEPT_LICENSE="*"

    # Language
    L10N="en-US zh-CN en zh"
    LINGUAS="en_US zh_CN en zh"

    # Else
    VIDEO_CARDS="intel i965"
    GRUB_PLATFORMS="pc coreboot"
  #+end_src
  my ryzen pc:
  #+begin_src conf
    # GCC
    CFLAGS="-march=znver1 -O2 -pipe"
    CXXFLAGS="${CFLAGS}"
    CHOST="x86_64-pc-linux-gnu"
    CPU_FLAGS_X86="aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 sse4a ssse3"
    MAKEOPTS="-j13"

    # USE
    USE="-bindist pulseaudio gtk"

    # Portage
    GENTOO_MIRRORS="https://mirrors.tuna.tsinghua.edu.cn/gentoo/"
    EMERGE_DEFAULT_OPTS="--ask --verbose=y --keep-going --with-bdeps=y --load-average"
    # FEATURES="${FEATURES} -userpriv -usersandbox -sandbox"
    ACCEPT_KEYWORDS="~amd64"
    ACCEPT_LICENSE="*"

    # Language
    L10N="en-US zh-CN en zh"
    LINGUAS="en_US zh_CN en zh"

    # Else
    VIDEO_CARDS="amdgpu radeonsi"
    GRUB_PLATFORMS="pc"
  #+end_src
  配置repos:
  #+begin_src bash
    ❯ mkdir /mnt/gentoo/etc/portage/repos.conf
      nano /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
  #+end_src
  #+begin_src conf
    [DEFAULT]
    main-repo = gentoo

    [gentoo]
    location = /var/db/repos/gentoo
    sync-type = git
    sync-uri = https://github.com/gentoo-mirror/gentoo
    auto-sync = yes
  #+end_src
  手动clone gentoo mirror repos:
  #+begin_src bash
    ❯ git clone --depths=1 https://github.com/gentoo-mirror/gentoo /mnt/gentoo/var/db/repos/gentoo
  #+end_src

  复制相关文件并chroot:
  #+begin_src bash
    # DNS
    ❯ cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
    # MOUNT
    ❯
      mount -t proc none proc 
      mount --rbind /sys sys 
      mount --rbind /dev dev
    # CHROOT
    ❯
      chroot /mnt/gentoo /bin/bash
      source /etc/profile
      export PS1="(chroot) ${PS1}"  
  #+end_src
  安装基础程序:
  #+begin_src bash
    ❯ emerge -av dev-vcs/git eix
  #+end_src
  选择profile:
  #+begin_src bash
    ❯ eselect profile list
      eselect profile set x
  #+end_src
  更新系统:
  #+begin_src bash
    ❯ eix-sync(可选)
    ❯ emerge -avuDN @world
  #+end_src
* 配置时区和地区 🌍
  #+begin_src bash
    ❯
      echo "Asia/Shanghai" > /etc/timezone
      emerge --config sys-libs/timezone-data

      echo "en_US.UTF-8 UTF-8
      zh_CN.UTF-8 UTF-8" >> /etc/locale.gen

      locale-gen

      eselect locale list

      eselect locale set X

      #修改主机名
      echo hostname=\"Thinkpad\" > /etc/conf.d/hostname
  #+end_src
* FSTAB 🪀
  #+begin_src bash
  
  #+end_src
